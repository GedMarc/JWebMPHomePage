public class LoginEvent
		extends DefaultClick
{
	private static final Logger log = LogFactory.getLog("LoginEvent");

	public LoginEvent()
	{
		this(null);
	}

	public LoginEvent(ComponentHierarchyBase component)
	{
		super(component);
		setID("LoginEvent");
		returnVariable("subscribe");
	}

	@Override
	public void onClick(AjaxCall call, AjaxResponse response)
	{
		Subscribers newSubs = call.getVariable("subscribe")
		                          .as(Subscribers.class);
		boolean subs = false;
		try
		{
			Optional<Subscribers> sub = Subscribers.findByLoginAndPassword(newSubs.getEmailAddress(), newSubs.getPassword());
			if (sub.isPresent())
			{
				Subscribers subscriber = sub.get();
				if (!subscriber.isConfirmed())
				{
					throw new UnsupportedOperationException("Looks like you're still waiting for a confirmation email.<br/>Please check your Spam or Junk folder");
				}

				SessionProperties properties = GuiceContext.getInstance(SessionProperties.class);
				properties.setSubscriber(sub.get());
				properties.setLoggedIn(true);

				subscriber.setLogInActive(true);
				subscriber.setRememberMe(newSubs.isRememberMe());

				subscriber.update();
				subscriber.builder()
				          .getEntityManager()
				          .flush();

				Visitors v = properties.getVisitor();

				//Do all the DB funky stuff in the backend
				LoginAsync la = new LoginAsync(newSubs, GuiceContext.getInstance(SessionProperties.class), sub.get(), v);
				Executors.defaultThreadFactory()
				         .newThread(la)
				         .start();

				response.addReaction(new AjaxResponseReaction().setReactionTitle("Logged In")
				                                               .setReactionData("You were successfully logged in")
				                                               .setResponseType(AjaxResponseType.Success)
				                                               .setReactionType(ReactionType.DialogDisplay));


				response.addComponent(GuiceContext.getInstance(HomePage.class));
				response.addComponent(GuiceContext.getInstance(TopBar.class));
				response.addComponent(GuiceContext.getInstance(West.class));
			}
		}
		catch (UnsupportedOperationException e)
		{
			response.addReaction(new AjaxResponseReaction().setReactionTitle("Awaiting your action")
			                                               .setReactionData(e.getMessage())
			                                               .setResponseType(AjaxResponseType.Warning)
			                                               .setReactionType(ReactionType.DialogDisplay));
		}
		catch (MissingComponentException e)
		{
			response.addComponent(new AlertMessage("Not quite right, try again...", BSAlertOptions.Alert_Warning));
		}
		catch (Exception e)
		{
			response.addComponent(new AlertMessage("That's a little odd, looks like me this time. It's all been logged.", BSAlertOptions.Alert_Warning));
			log.log(Level.SEVERE, "Error", e);
		}
		//Clear the login fields
		response.addDto("subscribe", null);
	}
}
